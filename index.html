<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 1. هوية الموقع و SEO -->
    <title>TAQWA – تقوى | القرآن الكريم، أذكار، ومصحف معلم</title>
    <meta name="description" content="منصة تقوى TAQWA: رفيقك المسلم اليومي. استمع للقرآن الكريم بأصوات أشهر القراء، اقرأ الأذكار، والمصحف المعلم للأطفال. تطبيق إسلامي شامل ومجاني يعمل بدون إنترنت جزئياً.">
    <meta name="keywords" content="تقوى, TAQWA, قرآن, القرآن الكريم, أذكار, أدعية, استماع قرآن, تطبيق إسلامي, مواقيت الصلاة, تسبيح, المصحف المعلم, تلاوات خاشعة, إسلام ويب, mp3 quran">
    <meta name="author" content="TAQWA">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://your-website-url.com">

    <!-- Open Graph for Social Media -->
    <meta property="og:title" content="TAQWA – تقوى | تطبيقك الإسلامي الشامل">
    <meta property="og:description" content="استمع للقرآن، ردد الأذكار، واستخدم السبحة الإلكترونية في منصة واحدة.">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/5350/5350172.png">
    <meta property="og:url" content="https://your-website-url.com">
    <meta property="og:type" content="website">

    <!-- PWA Settings -->
    <meta name="theme-color" content="#1E4D40">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts & Icons -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5350/5350172.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Schema Markup for Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "TAQWA – تقوى",
      "url": "https://your-website-url.com",
      "description": "تطبيق إسلامي شامل للقرآن والأذكار.",
      "applicationCategory": "ReligiousApplication",
      "operatingSystem": "All",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>

    <style>
        :root { --primary: #0f2e26; --gold: #C5A059; --white: #ffffff; --bg-body: #f8f9fa; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Tajawal', sans-serif; background-color: var(--bg-body);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e4d40' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: #333; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Typography H1 for SEO */
        h1 { display: none; } /* Hidden visually but present for SEO structure if needed, or styled in header */

        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s;
        }
        .splash-logo { width: 100px; height: 100px; border-radius: 20px; background: var(--gold); display: flex; justify-content: center; align-items: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(197, 160, 89, 0.4); }
        .splash-text { font-size: 2.5rem; color: white; font-weight: 900; letter-spacing: 1px; }
        .splash-sub { color: rgba(255,255,255,0.7); margin-top: 5px; font-size: 1.2rem; }

        .app-container { display: flex; height: 100%; position: relative; }
        .sidebar {
            width: 80px; background: var(--white);
            box-shadow: 2px 0 20px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 100;
        }
        .nav-btn {
            width: 50px; height: 50px; margin: 10px 0; border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.4rem; color: #ccc; cursor: pointer; transition: 0.3s; position: relative;
        }
        .nav-btn.active { background: var(--primary); color: var(--gold); transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .nav-btn .tooltip {
            position: absolute; right: 60px; background: #333; color: white; padding: 5px 10px;
            border-radius: 5px; font-size: 0.8rem; display: none; white-space: nowrap;
        }
        .nav-btn:hover .tooltip { display: block; }
        
        .content-area { flex: 1; padding: 20px; padding-bottom: 150px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }

        /* Branding Header */
        .brand-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .brand-title { font-size: 1.8rem; font-weight: 900; color: var(--primary); }
        .brand-title span { color: var(--gold); }
        
        /* Search & Cards */
        .search-bar {
            width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #eee;
            font-family: 'Tajawal'; font-size: 1rem; margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); outline: none; transition: 0.3s;
        }
        .search-bar:focus { border-color: var(--gold); box-shadow: 0 5px 20px rgba(197, 160, 89, 0.15); }
        
        .reciters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .reciter-card {
            background: var(--white); border-radius: 20px; padding: 15px; text-align: center;
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: 0.2s; cursor: pointer;
        }
        .reciter-card:active { transform: scale(0.96); }
        .avatar-unified {
            width: 70px; height: 70px; margin: 0 auto 10px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #000);
            display: flex; justify-content: center; align-items: center;
            color: var(--gold); font-size: 1.8rem; border: 3px solid #f8f8f8;
        }
        .pin-icon { position: absolute; top: 10px; left: 10px; color: #eee; font-size: 1.1rem; z-index: 2; transition: 0.2s; }
        .pin-icon.active { color: var(--gold); }

        /* Player */
        #persistent-player {
            position: fixed; bottom: 20px; left: 15px; right: 15px;
            background: linear-gradient(to right, #153e32, #0f2e26);
            border-radius: 25px; padding: 15px; display: none;
            align-items: center; justify-content: space-between;
            color: white; box-shadow: 0 10px 40px rgba(15, 46, 38, 0.4); z-index: 900;
        }
        .player-info { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
        .player-controls { display: flex; align-items: center; gap: 15px; }
        .play-btn { width: 45px; height: 45px; background: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 15px rgba(197, 160, 89, 0.5); }
        .player-actions { position: absolute; top: -12px; left: 15px; display: flex; gap: 8px; }
        .mini-btn { width: 26px; height: 26px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; cursor: pointer; background: #eee; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Fab & Modals */
        #kaaba-icon {
            position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; 
            background: var(--primary); border-radius: 18px; display: none; z-index: 999;
            justify-content: center; align-items: center; box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            cursor: pointer; border: 2px solid var(--gold); animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* Tasbih */
        .tasbih-container { display: flex; flex-direction: column; align-items: center; height: 70vh; justify-content: center; }
        .tasbih-circle {
            width: 260px; height: 260px; border-radius: 50%; background: white;
            border: 10px solid var(--primary); display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 10px 50px rgba(0,0,0,0.1); user-select: none; position: relative;
            transition: 0.1s;
        }
        .tasbih-circle:active { transform: scale(0.95); border-color: var(--gold); }
        
        /* Install PWA Button */
        #install-app-btn {
            background: var(--gold); color: var(--primary); border: none; padding: 10px 20px;
            border-radius: 10px; font-weight: bold; margin-bottom: 20px; cursor: pointer;
            display: none; align-items: center; gap: 10px; width: 100%; justify-content: center;
        }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: 75px; flex-direction: row; justify-content: space-around; position: fixed; bottom: 0; padding: 0; border-top: 1px solid #eee; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .nav-btn { margin: 0; background: none !important; color: #999; height: 100%; width: 100%; border-radius: 0; }
            .nav-btn.active { color: var(--primary); box-shadow: none; transform: none; border-top: 3px solid var(--primary); }
            .content-area { padding-bottom: 160px; }
            #persistent-player { bottom: 85px; }
            .reciters-grid { grid-template-columns: 1fr 1fr; }
            .brand-header { margin-top: 10px; }
        }
    </style>
</head>
<body>
    
    <!-- Splash Screen -->
    <div id="splash">
        <div class="splash-logo"><i class="fas fa-kaaba fa-3x" style="color:var(--primary)"></i></div>
        <div class="splash-text">TAQWA</div>
        <div class="splash-sub">تــقــوى</div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="nav-btn active" onclick="switchTab('reciters')">
                <i class="fas fa-users"></i>
            </div>
            <div class="nav-btn" onclick="switchTab('kids')">
                <i class="fas fa-child"></i>
            </div>
            <div class="nav-btn" onclick="switchTab('quran')">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="nav-btn" onclick="switchTab('tasbih')">
                <i class="fas fa-fingerprint"></i>
            </div>
            <div class="nav-btn" onclick="shareApp()">
                <i class="fas fa-share-alt"></i>
            </div>
        </nav>

        <main class="content-area">
            
            <!-- Install App Button (Shows only if supported) -->
            <button id="install-app-btn" onclick="installPWA()">
                <i class="fas fa-download"></i> تثبيت تطبيق تقوى
            </button>

            <!-- Header -->
            <header class="brand-header">
                <div class="brand-title">TAQWA <span>تقوى</span></div>
                <i class="fas fa-cog" style="color:#ccc; cursor:not-allowed"></i>
            </header>

            <!-- Reciters Section -->
            <section id="reciters" class="section active">
                <h1 style="font-size:1.2rem; margin-bottom:15px; color:#666;">اختر قارئك المفضل</h1>
                <input type="text" class="search-bar" placeholder="ابحث عن قارئ (مثل: العفاسي)..." onkeyup="filterReciters(this.value)">
                <div class="reciters-grid" id="recitersList"></div>
            </section>

            <!-- Kids Section -->
            <section id="kids" class="section">
                <div style="background:linear-gradient(45deg, #FF9F43, #ff6b6b); color:white; padding:25px; border-radius:20px; margin-bottom:20px; text-align:center; box-shadow: 0 10px 20px rgba(255, 159, 67, 0.3);">
                    <i class="fas fa-star fa-2x" style="margin-bottom:10px;"></i>
                    <h3>المصحف المعلم</h3>
                    <p style="opacity:0.9">الشيخ الحصري (ترديد الأطفال)</p>
                </div>
                <div class="reciters-grid" id="kidsList"></div>
            </section>

            <!-- Quran Reading Section -->
            <section id="quran" class="section">
                <div style="text-align:center; padding-top:30px;">
                    <i class="fas fa-quran fa-4x" style="color:var(--primary); margin-bottom:20px;"></i>
                    <h3>المصحف الشريف</h3>
                    <p style="color:#888; margin-bottom:20px;">اقرأ القرآن الكريم كاملاً بخط واضح</p>
                    <select id="readerSelect" style="width:100%; padding:15px; margin:10px 0; border-radius:12px; border:1px solid #ddd; background:#fff; font-family:'Tajawal'"></select>
                    <button onclick="openReader()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; font-size:1rem; cursor:pointer;">قراءة السورة</button>
                </div>
            </section>

            <!-- Tasbih Section -->
            <section id="tasbih" class="section">
                <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:10px;">
                    <button class="tasbih-cat active" style="border:none; background:var(--primary); color:white; padding:8px 20px; border-radius:20px; white-space:nowrap" onclick="setTasbih(this, 'سبحان الله')">سبحان الله</button>
                    <button class="tasbih-cat" style="border:1px solid #ddd; background:white; padding:8px 20px; border-radius:20px; white-space:nowrap" onclick="setTasbih(this, 'الحمد لله')">الحمد لله</button>
                    <button class="tasbih-cat" style="border:1px solid #ddd; background:white; padding:8px 20px; border-radius:20px; white-space:nowrap" onclick="setTasbih(this, 'أستغفر الله')">أستغفر الله</button>
                </div>
                <div class="tasbih-container">
                    <div class="tasbih-circle" onclick="doTasbih()">
                        <div style="position:absolute; top:30px; color:#999; font-size:0.9rem;">العدد</div>
                        <span id="tasbihVal" style="font-size:4rem; font-weight:bold; color:var(--primary);">0</span>
                        <span id="currentDhikr" style="font-size:1.1rem; color:var(--gold); margin-top:5px; font-weight:bold;">سبحان الله</span>
                    </div>
                    <button onclick="resetTasbih()" style="margin-top:30px; background:transparent; border:2px solid #eee; color:#666; padding:8px 30px; border-radius:20px; cursor:pointer;">تصفير العداد</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Audio Player -->
    <div id="persistent-player">
        <div class="player-actions">
            <div class="mini-btn" onclick="minimizePlayer()">_</div>
            <div class="mini-btn" onclick="closePlayer()" style="background:#ff4757; color:white;">✕</div>
        </div>
        <div class="player-info" onclick="maximizePlayer()">
            <div style="display:flex; flex-direction:column;">
                <span id="p-title" style="font-weight:bold; font-size:0.95rem;">اسم السورة</span>
                <span id="p-reciter" style="font-size:0.8rem; opacity:0.8;">القارئ</span>
            </div>
        </div>
        <div class="player-controls">
            <i class="fas fa-list" onclick="toggleSurahMenu()" style="cursor:pointer; opacity:0.8"></i>
            <i class="fas fa-backward-step" onclick="prevTrack()" style="cursor:pointer; font-size:1.2rem"></i>
            <div class="play-btn" onclick="togglePlay()"><i class="fas fa-play" id="playIcon"></i></div>
            <i class="fas fa-forward-step" onclick="nextTrack()" style="cursor:pointer; font-size:1.2rem"></i>
        </div>
    </div>

    <!-- Floating Icon -->
    <div id="kaaba-icon" onclick="maximizePlayer()">
        <i class="fas fa-compact-disc fa-spin" style="color:var(--gold); font-size:2rem; animation-duration: 3s;"></i>
    </div>

    <!-- Playlist Modal -->
    <div id="playlistModal" style="position:fixed; bottom:0; left:0; width:100%; height:75vh; background:white; z-index:1000; border-radius:25px 25px 0 0; box-shadow:0 -10px 50px rgba(0,0,0,0.2); transform:translateY(110%); transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); display:flex; flex-direction:column;">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:1.2rem;">قائمة السور</span>
            <div onclick="toggleSurahMenu()" style="background:#f5f5f5; width:30px; height:30px; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer;">✕</div>
        </div>
        <div id="playlistContent" style="flex:1; overflow-y:auto; padding:10px;"></div>
    </div>

    <!-- Reader Fullscreen -->
    <div id="fullReader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fffbf2; z-index:2000; display:none; flex-direction:column; overflow-y:auto;">
        <div style="position:fixed; top:20px; left:20px; z-index:2001;">
            <button onclick="closeReader()" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:50%; border:none; box-shadow:0 5px 15px rgba(0,0,0,0.2); cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <div id="readerText" style="padding:80px 20px; font-family:'Amiri'; font-size:26px; line-height:2.6; text-align:justify; max-width:800px; margin:0 auto;"></div>
    </div>

    <audio id="audio"></audio>

    <script>
        // --- 1. إعدادات البيانات والمشغل ---
        const recitersData = [
            { id: 'afs', name: 'مشاري العفاسي', server: 'https://server8.mp3quran.net/afs/' },
            { id: 'maher', name: 'ماهر المعيقلي', server: 'https://server12.mp3quran.net/maher/' },
            { id: 'sds', name: 'عبدالرحمن السديس', server: 'https://server11.mp3quran.net/sds/' },
            { id: 'dosari', name: 'ياسر الدوسري', server: 'https://server11.mp3quran.net/yasser/' },
            { id: 'ajm', name: 'أحمد العجمي', server: 'https://server10.mp3quran.net/ajm/' },
            { id: 'shur', name: 'سعود الشريم', server: 'https://server7.mp3quran.net/shur/' },
            { id: 'minsh', name: 'المنشاوي (مجود)', server: 'https://server10.mp3quran.net/minsh/' },
            { id: 'hazza', name: 'هزاع البلوشي', server: 'https://server11.mp3quran.net/hazza/' },
            { id: 'islam', name: 'اسلام صبحي', server: 'https://server14.mp3quran.net/islam/Rewayat-Hafs-A-n-Assem/' },
            { id: 'kurdi', name: 'رعد الكردي', server: 'https://server6.mp3quran.net/kurdi/' }
        ];
        const KIDS_SERVER = "https://server6.mp3quran.net/husr_m/";
        let allSurahs = [];
        let favorites = JSON.parse(localStorage.getItem('favs')) || [];
        let currentReciter = null;
        let currentSurahIndex = 0;
        const audio = document.getElementById('audio');

        // --- 2. تهيئة الموقع ---
        window.onload = async () => {
            // شاشة الترحيب
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').remove(), 1000);
            }, 2000);

            await fetchSurahs();
            renderReciters();
            renderKids();

            // تسجيل Service Worker للـ PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW Registered', reg))
                .catch(err => console.log('SW Failed', err));
            }
        };

        // --- 3. وظائف PWA وتثبيت التطبيق ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('install-app-btn');
            installBtn.style.display = 'flex';
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-app-btn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        // --- 4. وظيفة المشاركة Share ---
        async function shareApp() {
            const shareData = {
                title: 'TAQWA – تقوى',
                text: 'استمع للقرآن الكريم واستخدم السبحة الإلكترونية في تطبيق تقوى.',
                url: window.location.href
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            } else {
                // بديل للمتصفحات القديمة
                const msg = encodeURIComponent(shareData.text + " " + shareData.url);
                const whatsapp = `https://wa.me/?text=${msg}`;
                window.open(whatsapp, '_blank');
            }
        }

        // --- 5. وظائف المنطق الأساسية (كما كانت مع تحسينات طفيفة) ---
        async function fetchSurahs() {
            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                allSurahs = data.data;
                const select = document.getElementById('readerSelect');
                allSurahs.forEach(s => select.innerHTML += `<option value="${s.number}">${s.number}. ${s.name}</option>`);
            } catch(e) { console.error("Error fetching surahs"); }
        }

        function renderReciters(filter = "") {
            const container = document.getElementById('recitersList');
            container.innerHTML = '';
            
            let sortedReciters = [...recitersData].sort((a, b) => {
                const aFav = favorites.includes(a.id);
                const bFav = favorites.includes(b.id);
                return bFav - aFav; 
            });

            if(filter) {
                sortedReciters = sortedReciters.filter(r => r.name.includes(filter));
            }

            sortedReciters.forEach(r => {
                const isFav = favorites.includes(r.id);
                container.innerHTML += `
                    <div class="reciter-card" onclick="playReciter('${r.id}')">
                        <i class="fas fa-thumbtack pin-icon ${isFav ? 'active' : ''}" onclick="togglePin(event, '${r.id}')"></i>
                        <div class="avatar-unified"><i class="fas fa-user-tie"></i></div>
                        <div style="font-weight:bold; color:var(--primary); font-size:0.95rem;">${r.name}</div>
                    </div>
                `;
            });
        }
        
        function filterReciters(val) { renderReciters(val); }
        
        function togglePin(e, id) {
            e.stopPropagation();
            if(favorites.includes(id)) favorites = favorites.filter(f => f !== id);
            else favorites.push(id);
            localStorage.setItem('favs', JSON.stringify(favorites));
            renderReciters();
        }

        function renderKids() {
            const container = document.getElementById('kidsList');
            const check = setInterval(() => {
                if(allSurahs.length > 0) {
                    clearInterval(check);
                    const kidsSurahs = [1, ...Array.from({length:37}, (_,i)=>i+78)];
                    kidsSurahs.forEach(num => {
                        const s = allSurahs[num-1];
                        container.innerHTML += `
                            <div class="reciter-card" onclick="playAudio('${KIDS_SERVER}', 'المصحف المعلم', ${num-1})">
                                <i class="fas fa-cloud-sun" style="font-size:2rem; color:#FF9F43; margin-bottom:10px;"></i>
                                <div style="font-size:0.9rem;">${s.name}</div>
                            </div>
                        `;
                    });
                }
            }, 100);
        }

        // --- وظائف التشغيل ---
        function playReciter(id) {
            currentReciter = recitersData.find(r => r.id === id);
            playAudio(currentReciter.server, currentReciter.name, 0);
        }

        function playAudio(server, reciterName, surahIndex) {
            currentSurahIndex = surahIndex;
            if(!currentReciter || currentReciter.server !== server) {
                 currentReciter = { server: server, name: reciterName };
            }

            const surah = allSurahs[surahIndex];
            const numStr = String(surah.number).padStart(3, '0');
            const url = `${server}${numStr}.mp3`;
            
            audio.src = url;
            audio.play();
            
            // تحديث واجهة المشغل
            const player = document.getElementById('persistent-player');
            player.style.display = 'flex';
            document.getElementById('kaaba-icon').style.display = 'none';
            document.getElementById('p-title').innerText = surah.name;
            document.getElementById('p-reciter').innerText = reciterName;
            document.getElementById('playIcon').className = 'fas fa-pause';
            
            // تحديث الميديا في شاشة القفل (للهواتف)
            if('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: surah.name,
                    artist: reciterName,
                    album: 'TAQWA - تقوى',
                    artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/5350/5350172.png', sizes: '512x512', type: 'image/png' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
                navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
            }
        }

        function togglePlay() {
            if(audio.paused) { audio.play(); document.getElementById('playIcon').className = 'fas fa-pause'; }
            else { audio.pause(); document.getElementById('playIcon').className = 'fas fa-play'; }
        }

        function nextTrack() { if(currentSurahIndex < 113) playAudio(currentReciter.server, currentReciter.name, currentSurahIndex + 1); }
        function prevTrack() { if(currentSurahIndex > 0) playAudio(currentReciter.server, currentReciter.name, currentSurahIndex - 1); }

        function toggleSurahMenu() {
            const modal = document.getElementById('playlistModal');
            const content = document.getElementById('playlistContent');
            
            if(modal.style.transform === 'translateY(0%)') {
                modal.style.transform = 'translateY(110%)';
            } else {
                content.innerHTML = '';
                allSurahs.forEach((s, idx) => {
                    // تمييز السورة الحالية
                    const isActive = idx === currentSurahIndex ? 'background:#f0f7f4; font-weight:bold; color:var(--primary);' : '';
                    content.innerHTML += `
                        <div style="padding:15px; border-bottom:1px solid #f9f9f9; display:flex; justify-content:space-between; cursor:pointer; border-radius:10px; ${isActive}" onclick="playAudio('${currentReciter.server}', '${currentReciter.name}', ${idx}); toggleSurahMenu()">
                            <span>${s.number}. ${s.name}</span>
                            <i class="fas fa-play" style="color:#ddd; font-size:0.8rem;"></i>
                        </div>
                    `;
                });
                modal.style.transform = 'translateY(0%)';
            }
        }

        function minimizePlayer() {
            document.getElementById('persistent-player').style.display = 'none';
            document.getElementById('kaaba-icon').style.display = 'flex';
        }
        function maximizePlayer() {
            document.getElementById('persistent-player').style.display = 'flex';
            document.getElementById('kaaba-icon').style.display = 'none';
        }
        function closePlayer() {
            audio.pause();
            document.getElementById('persistent-player').style.display = 'none';
            document.getElementById('kaaba-icon').style.display = 'none';
        }

        // --- وظائف التسبيح ---
        let tasbihCount = 0;
        function setTasbih(el, dhikr) {
            document.querySelectorAll('.tasbih-cat').forEach(c => {
                c.style.background = 'white'; c.style.color='#333';
            });
            el.style.background = 'var(--primary)'; el.style.color = 'white';
            document.getElementById('currentDhikr').innerText = dhikr;
            resetTasbih();
        }

        function doTasbih() {
            tasbihCount++;
            document.getElementById('tasbihVal').innerText = tasbihCount;
            if(navigator.vibrate) navigator.vibrate(30);
        }

        function resetTasbih() {
            tasbihCount = 0;
            document.getElementById('tasbihVal').innerText = 0;
        }

        // --- وظائف القراءة ---
        async function openReader() {
            const num = document.getElementById('readerSelect').value;
            if(!num) return;
            document.getElementById('fullReader').style.display = 'flex';
            const txt = document.getElementById('readerText');
            txt.innerHTML = '<div style="text-align:center; color:var(--primary)">جاري تحميل السورة...</div>';
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/quran-uthmani`);
                const data = await res.json();
                let html = `<h2 style="color:var(--primary); margin-bottom:30px; text-align:center;">${data.data.name}</h2>`;
                if(num!=1 && num!=9) html += `<div style="margin-bottom:20px; text-align:center;">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>`;
                
                // دمج الآيات
                let fullText = "";
                data.data.ayahs.forEach(a => {
                    fullText += `${a.text} <span style="color:var(--gold); font-size:0.7em; font-family:'Tajawal'; border:1px solid #ddd; border-radius:50%; width:25px; height:25px; display:inline-flex; justify-content:center; align-items:center; margin:0 5px;">${a.numberInSurah.toLocaleString('ar-EG')}</span> `;
                });
                
                txt.innerHTML = html + fullText;
            } catch(e) { txt.innerHTML = "حدث خطأ في التحميل، تأكد من اتصالك بالإنترنت."; }
        }
        function closeReader() { document.getElementById('fullReader').style.display = 'none'; }

        // --- التنقل ---
        function switchTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // تحديد الزر النشط بناءً على الترتيب
            const btns = document.querySelectorAll('.nav-btn');
            if(id === 'reciters') btns[0].classList.add('active');
            if(id === 'kids') btns[1].classList.add('active');
            if(id === 'quran') btns[2].classList.add('active');
            if(id === 'tasbih') btns[3].classList.add('active');
        }
    </script>
</body>
</html>
